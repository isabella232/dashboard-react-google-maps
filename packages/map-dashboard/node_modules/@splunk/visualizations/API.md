# Visualizations API

Visualization is a React component with the following props defined:

```js
import { Component } from 'react';
import T from 'prop-types';
import { noop } from 'lodash';

class SplunkVisualization extends Component {
    static propTypes = {
        /**
         * display mode
         */
        mode: T.oneOf(['view', 'edit', 'export']).isRequired,
        /**
         * width in pixels or string, defaults to 100%
         */
        width: T.oneOfType([T.string, T.number]).isRequired,
        /**
         * height in pixels or string
         */
        height: T.oneOfType([T.string, T.number]).isRequired,
        /**
         * visualization context used for dynamic option evaluation
         */
        context: T.object,
        /**
         * visualization formatting options
         */
        options: T.object,
        /**
         * A callback to update formatting options
         */
        onOptionsChange: T.func,
        /**
         * datasource state which include data and request params, object key indicate the datasource type.
         */
        dataSources: T.objectOf(
            T.shape({
                /**
                 * current request params
                 */
                requestParams: T.object,
                /**
                 * current dataset
                 */
                data: T.shape({
                    fields: T.array,
                    columns: T.array,
                }),
                /**
                 * error
                 */
                error: T.shape({
                    level: T.string,
                    message: T.string,
                }),
                /**
                 * meta data that came with the dataset
                 */
                meta: T.object,
            })
        ),
        /**
         * A callback to trigger event
         */
        onEventTrigger: T.func,
        /**
         * Inform viz if there are handlers listening to events
         */
        hasEventHandlers: T.bool,
        /**
         * A callback to communicate computed props to a consumer
         */
        onComputedProps: T.func,
        /**
         * A callback to obtain visualization api
         */
        vizActionHandlerRef: T.func,
        /**
         * If set to "true" there will be an indication that the visualization data is loading
         */
        loading: T.bool,
        theme: T.object,
        /**
         * A callback to request new data with updated request params
         */
        onRequestParamsChange: T.func,
    };
    static defaultProps = {
        width: '100%',
        height: 250,
        dataSources: {},
        onEventTrigger: () => {},
        mode: 'view',
        hasEventHandlers: false,
        options: {},
        context: {},
        onOptionsChange: () => {},
        vizActionHandlerRef: () => {},
        onComputedProps: () => {},
        loading: false,
        onRequestParamsChange: noop,
    };
}

export default SplunkVisualization;
```

## Basic Principle

### A visualization should

-   Honestly present data with specific formatting options.
-   Communicate events with an `onEventTrigger` callback.
-   Be predictable. Always render identical result given a fixed dataset and options.

### A visualization should NOT

-   Depend on global variables.
-   Issue requests to fetch data.

## Visualization Data

The Visualization component reads data from a dataSources object in json_cols format.

For example:

```js
dataSources={{
    primary: {
        requestParams: { offset: 0, count: 20 },
        data: {
            fields: [{ name: 'component' }, { name: 'count' }, { name: 'percent' }],
            columns: [
                        [
                            'splunkd',
                            'splunkd_ui_access',
                            'splunkd_access',
                            'splunk_web_access',
                            'scheduler',
                            'splunk_web_service',
                        ],
                        ['600', '525', '295', '213', '122', '19'],
                        ['87.966380', '50.381304', '60.023780', '121.183272', '70.250513', '90.194752'],
            ],
        },
        meta: { totalCount: 100 },
    },
}}
```

### RequestParams

The RequestParams object defines how a visualization reacts with the data sets.

The following example returns the first 20 results of a given data source:

```js
{
    requestParams: { offset: 0, count: 20 },
    data: {
        fields: [{ name: 'component' }, { name: 'count' }, { name: 'percent' }],
        columns: [
                    [
                        'splunkd',
                        'splunkd_ui_access',
                        'splunkd_access',
                        'splunk_web_access',
                        'scheduler',
                        'splunk_web_service',
                    ],
                    ['600', '525', '295', '213', '122', '19'],
                    ['87.966380', '50.381304', '60.023780', '121.183272', '70.250513', '90.194752'],
        ],
    },
    meta: { totalCount: 100 },
}
```

If necessary, the Visualization component can invoke the `onRequestParamsChange` callback to request data with updated request parameters (RequestParams).

For Example:

```js
this.props.onRequestParamsChange('primary', {
    ...this.props.dataSources.primary.requestParams,
    offset: 20,
    count: 20,
});
```

A complete example can be found under _Update RequestParams_ from the Table visualization.

All available RequestParams are documented in the DataSource module.

### DataSources

DataSource is a module that does the data fetching, see @splunk/datasources for more details.

-   While Visualization and DataSource are designed to work together, Visualization itself can be used as a standalone React component.
-   Each Visualization can be powered by multiple DataSources - 0 to 1 `primary` DataSource and 0 to n secondary DataSource

### Data Contract

Each visualization exposes a property called `dataContract` to indicate which datasources are supported.

The following snippet is an example data contract:

```js
const dataContract = {
    requiredDataSources: [
        {
            name: 'primary',
            description: 'DataSource that powers the visualization',
        },
    ],
    optionalDataSources: [
        {
            name: 'annotation',
            description: 'DataSource that populates event annotations',
        },
    ],
    initialRequestParams: {
        primary: { offset: 0, count: 10000 },
    },
};
```

From the data contract above, UDF is able to infer that the visualization requires one datasource called `primary` and supports an optional datasource called `annotation`. It also exposes initialRequestParams to let datasources know what parameters to use for the initial fetching of data.

#### Supported DataSources

The data contract contains a property `requiredDataSources` and `optionalDataSources` to indicate what kind of DataSources it supports.

For example, Table only supports primary DataSource:

```js
const dataContract = {
    requiredDataSources: [
        {
            name: 'primary',
            description: 'DataSource that powers the visualization',
        },
    ],
    //...
};
```

while Line Chart supports an additional annotation DataSource:

```js
const dataContract = {
    requiredDataSources: [
        {
            name: 'primary',
            description: 'DataSource that powers the visualization',
        },
    ],
    optionalDataSources: [
        {
            name: 'annotation',
            description: 'DataSource that populates event annotations',
        },
    ],
    //...
};
```

#### Initial RequestParams

In order to retrieve the first batch of data, the initial RequestParams needs to be figured out before the Visualization gets rendered. The `initialRequestParams` property in the `dataContract` serves this purpose.

initialRequestParams can be an object

```js
initialRequestParams: {
    offset: 0,
    count: 10000,
}
```

or a function that takes the visualization options and returns the initial RequestParams

```js
initialRequestParams: (options = {}) => ({
    offset: 0,
    count: options.count || 20,
});
```

## Meta

Meta object tells visualization extra information besides the data.

For example:

```js
{
    totalCount: 100, // total results
    progress: 50, // 0-100, current search progress
}
```

It's up to the viz implementation to decide whether to use them. Checkout Meta from DataSource package for details.

## Size

If either `width` or `height` is provided, the visualization will render within the specified dimensions and handle the size change.

## onComputedProps

`onComputedProps` allows visualizations to communicate calculated props (e.g. a background color that is calculated based on data) upwards to its consumer.

For Example:

```js
const TitleContainer = styled.div`
    background-color: ${props => props.backgroundColor};
`;
const DashboardWrapper = props => {
    const [state, setState] = useState({ backgroundColor: '#f00' });
    const { title, ...otherVizProps } = props;
    return (
        <>
            <TitleContainer backgroundColor={state.backgroundColor}>{title}</TitleContainer>
            <Visualization {...otherVizProps} onComputedProps={setState} />
        </>
    );
};
```

### Visualization Config

The visualization config is used to programmatically reason about a visualization at build & runtime

A visualization `config` contains the following properties:

-   **key**: Preset key used in the definition. Key format must be 'splunk.type'. Example: splunk.customBar
-   **name**: The canonical name for the visualization. Recommended format is splunk.type Visualization. Example: Custom Bar Visualization
-   **category**: Visualization class. Currently available categories are 'Table', 'Single Value', 'Trends', 'Comparisons', 'Gauge', 'Distributions', 'Shapes', 'Flow' and 'Choropleth Maps'
-   **icon**: A react element that renders an svg icon
-   **dataContract**: The data contract defines the availability for the visualization to use a datasource, and the default configuration for results. This configuration is also used by the editing interface to determine what datasources need to be configured
-   **optionsSchema**: The schema is used to validate the properties of a datasource configuration and is also used in concert with the editor config to provide default values. This should be a standard [json schema](https://json-schema.org/)
-   **editorConfig**: The editor static property defines a configuration that renders an editor in the sidebar
-   **size**: The size dimensions for the visualization
-   **events**: User interaction events that the visualization allows (e.g. click of a Pie slice, hover on a data point in a Line chart)
-   **defaultContext**: A place where DSL configuration variables can be defined. Used when no context is configured
-   **supports**: A list of supported behaviors by the visualization component
-   **themes**: An object that denotes key-value pairs of functions that return resolved values used to style the visualization based on the theme
-   **requiredProps**: A list of properties that must be defined in order for the placeholder to be replaced with the actual vizualization

The following snippet is an example Visualization config:

```js
const LinkGraphConfig = {
    key: 'splunk.linkgraph',
    name: 'Link Graph',
    icon: LinkGraphIcon,
    optionsSchema: {},
    editorConfig: {},
    events: {},
};
```
